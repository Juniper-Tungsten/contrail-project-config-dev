- name: Ensure that test logs are readable by the zuul user
  shell: |
    find {{ ansible_env.HOME }} -name '*.log*' -type f -exec chmod 0644 {} \;
  become: yes
  become_user: root

- name: Get a list of existing log files
  find:
    paths: .
    file_type: any
    patterns:
      - retry_targets.txt
      - retry_tests.txt
      - scons_test-FAIL.log
      - scons_test.log
      - scons_test_retry.log
      - unittests-logs
  register: loglist

- name: Gzip log files
  archive:
    path: "{{ item.path }}"
    remove: true
  with_items: "{{ loglist.files }}"

- name: Send logs to the executor
  synchronize:
    mode: pull
    src: "{{ item.path }}.gz"
    dest: "{{ zuul.executor.log_root }}/"
  with_items: "{{ loglist.files }}"
